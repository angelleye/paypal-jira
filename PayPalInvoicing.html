<!DOCTYPE html>
<html lang="en">

    <head>

        <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-migrate/1.4.1/jquery-migrate.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/sinon.js/1.15.4/sinon.js"></script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/aui/7.6.0/aui/js/aui.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/aui/7.6.0/aui/js/aui-experimental.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/aui/7.6.0/aui/js/aui-datepicker.min.js"></script>

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/aui/7.6.0/aui/css/aui.min.css" media="all">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/aui/7.6.0/aui/css/aui-experimental.min.css" media="all">

        <style>
            .custom-field-group {
                padding-left: 66px !important;
            }

            .form.aui .select {
                padding: 2px 5px 5px 5px !important;
            }

            .mt20 {
                margin-top: 20px !important;
            }

            .add-item-btn {
                background-color: #ecf7fc;
                border: 1px solid #91d4f0;
                padding: 10px;
                margin: 10px 0;
                width: 100%;
                display: inline-block;
            }

            .add-item-btn:hover {
                color: #004975;
            }

            .add-item {
                width: 100%;
            }

            .total-section {
                display: inline-block;
                border-top: 2px solid #ddd;
            }

            .sub-total-table {
                border: 2px solid #ddd;
                border-collapse: collapse;
                text-align: right;
            }

            .sub-total-table tr td,
            .sub-total-table tr th {
                padding: 10px;
                border: 1px solid #ddd;
            }

            .grey-bg {
                background-color: #f6f6f6;
            }

            .txtareacls{
                float: unset !important;
                margin-left: 0 !important;
                padding: 0 !important;
                text-align: left !important;
            }

            .txtarea{
                font-family: inherit;
                line-height: 1.4285714285714;
                margin: 0;
                padding: 4px 5px;
                border: 1px solid #ccc;
                border-radius: 3.01px;
                box-sizing: border-box;
                width: 100%;
            }

        </style>
    </head>

    <body class="aui-page-fixed">
        <div id="page">
            <section id="content" class="ac-content" role="main">
                <header class="aui-page-header">
                    <div class="aui-page-header-inner">
                        <div class="aui-page-header-main">            
                            <a href="https://www.angelleye.com/" target="_blank" title="AngellEye"><img alt="AngellEye logo" src="images/logo.png"></a>
                        </div>
                    </div>
                </header>
                <div class="aui-page-panel">
                    <div class="aui-page-panel-inner">
                        <section class="aui-page-panel-content">
                            <form class="aui">
                                <div class="aui-group">
                                    <div class="aui-item">
                                        <img src="images/your-logo-here.png" height="150" width="150" id="logoid">
                                    </div>
                                    <div class="aui-item"></div>
                                    <div class="aui-item">
                                        <div class="field-group">
                                            <label for="invoiceNumber">Invoice Number</label>
                                            <input class="text" type="text" id="invoiceNumber" name="invoiceNumber" title="Invoice Number" maxlength="25">
                                        </div>
                                        <div class="field-group">
                                            <label for="issueDate">Invoice Date</label>
                                            <input class="text aui-date-picker" id="issueDate"  name="issueDate" type="date" />
                                        </div>
                                        <div class="field-group">
                                            <label for="reference">Reference</label>
                                            <input class="text" type="text" id="reference" name="reference" title="Referance" placeholder="Such as PO#">
                                        </div>
                                        <div class="field-group">
                                            <label for="dueDate">Due Date</label>
                                            <input class="text aui-date-picker" id="dueDate" name="dueDate" type="date" />
                                        </div>
                                    </div>
                                </div>

                                <div class="aui-group aui-group-split">
                                    <div class="aui-item">
                                        <div class="field-group custom-field-group">
                                            <label for="billToEmail"><h4>Bill to:</h4></label>
                                            <input class="text full-width-field" type="text" id="billToEmail" name="billToEmail" title="Bill to">
                                        </div>
                                        <div class="field-group custom-field-group">
                                            <label for="billToEmailCc"><h4>Cc:</h4></label>
                                            <input class="text full-width-field" type="text" id="billToEmailCc" name="billToEmailCc" title="Cc">
                                        </div>
                                    </div>
                                    <div class="aui-item"></div>
                                </div>
                                <div class="aui-group mt20">
                                    <div class="aui-item">
                                        <table class="aui">
                                            <thead>
                                                <tr>
                                                    <th id="basic-desc">Description</th>
                                                    <th id="basic-qty">Quantity</th>
                                                    <th id="basic-price">Price</th>
                                                    <th id="basic-tax">Tax</th>
                                                    <th id="basic-amt">Amount</th>
                                                    <th></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr class="ae_row" id="ae_row_0">
                                                    <td headers="basic-desc">
                                                        <input class="text full-width-field" type="text" id="itemName_0" name="itemName" title="Item name" placeholder="Item name">
                                                        <textarea class="textarea full-width-field" name="itemDescription" id="itemDescription_0" placeholder="Enter detailed description (optional)" style="margin-top: 5px;"></textarea>
                                                    </td>
                                                    <td headers="basic-qty"><input class="text short-field" type="text" id="itemQty_0" name="itemQty" title="Quantity" value="1"></td>
                                                    <td headers="basic-price"><input class="text short-field" type="text" id="itemPrice_0" name="itemPrice" title="Price" value="0.00"></td>
                                                    <td headers="basic-tax">
                                                        <input class="text short-field" type="text" id="taxName_0" name="taxName" title="Tax" placeholder="Name">
                                                        <input class="text short-field" type="text" id="taxRate_0" name="taxRate" title="Tax" placeholder="Amount" value="0.00"> %
                                                    </td>
                                                    <td headers="basic-amt" class="grey-bg"><input type="text" id="basicAmt_0" name="basicAmt" disabled="disabled" value="$0.00" class="text short-field"></td>
                                                    <td></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <div class="aui-group">
                                    <div class="aui-item">
                                        <div class="add-item">
                                            <a class="add-item-btn" href="#" id="add_new_item"><span class="aui-icon aui-icon-small aui-iconfont-add"></span> Add another line item</a>
                                        </div>
                                    </div>
                                </div>

                                <div class="aui-group aui-group-split mt20">
                                    <div class="aui-item">
                                        <div class="checkbox">
                                            <input class="checkbox" type="checkbox" name="allowPartialPayments" id="allowPartialPayments">
                                            <label for="allowPartialPayments">Allow partial payment</label>
                                        </div>
                                        <div class="mamout" style="display: none">
                                            <label for="d-fname-short">Minimum amount due (optional)</label>
                                            <input class="text short-field" type="text" id="minimumDueAmount" name="minimumDueAmount" title="Minimum amount due"><label> USD</label>
                                        </div>
                                        <div class="checkbox">
                                            <input class="checkbox" type="checkbox" name="allowTips" id="allowTips">
                                            <label for="allowTips">Allow customer to add a tip.</label>
                                        </div>
                                    </div>

                                    <div class="aui-item">
                                        <div class="total-section">
                                            <table class="sub-total-table">
                                                <tbody>
                                                    <tr>
                                                        <th colspan="3">Subtotal</th>
                                                        <td class="grey-bg itemSubTotal">$0.00</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Discount</th>
                                                        <td>
                                                            <input type="text" name="invDiscount" id="invDiscount" class="text short-field" value="0.00">
                                                        </td>
                                                        <td>
                                                            <select name="invoiceDiscType" id="invoiceDiscType" class="select">
                                                                <option value="percentage">%</option>
                                                                <option value="dollar">$</option>
                                                            </select>
                                                        </td>
                                                        <td class="grey-bg invoiceDiscountAmount">$0.00</td>
                                                    </tr>
                                                    <tr>
                                                        <th>Shipping</th>
                                                        <td colspan="2">
                                                            <input type="text" name="shippingAmount" id="shippingAmount" class="text short-field" value="0.00">
                                                        </td>                                                        
                                                        <td class="grey-bg shippingAmountTd">$0.00</td>
                                                    </tr>
                                                    <tr class="grey-bg">
                                                        <th colspan="3">Total</th>                                                        
                                                        <td class="finalTotal">$0.00 USD</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div class="aui-group mt20">
                                    <div class="aui-item">
                                        <div class="field-group" style="padding-left:0">
                                            <label for="notes" class="txtareacls"><h4 style="margin-bottom:10px">Note to recipient</h4></label>
                                            <textarea class="txtarea" name="notes" rows="5" id="notes" placeholder="Such as 'Thank you for your business'"></textarea>
                                        </div>
                                    </div>
                                    <div class="aui-item">
                                        <div class="field-group" style="padding-left:0">
                                            <label for="terms" class="txtareacls"><h4 style="margin-bottom:10px">Terms and conditions</h4></label>
                                            <textarea class="txtarea" name="terms" rows="5" id="terms" placeholder="Include your return or cancelation policy"></textarea>
                                        </div>
                                    </div>
                                </div>
                                <div class="aui-group aui-group-split mt20">
                                    <div class="aui-item">
                                        <div class="">
                                            <label for="uploadFile">Attach file</label>
                                            <input class="upfile" type="file" multiple="multiple" id="uploadAttachment" name="attachFiles[]" title="upload file" accept="application/xml,text/xml,application/pdf,image/gif,image/jpeg,image/png,image/tiff,image/bmp">
                                        </div>
                                        <div class="checkbox mt20">
                                            <input class="checkbox" type="checkbox" name="addMemoDesc" id="addMemoDesc">
                                            <label for="addMemoDesc">Add memo to self</label>
                                        </div>
                                        <div class="field-group aememodesc" style="padding-left:0;display: none">
                                            <textarea class="txtarea" name="memodesc" rows="5" id="memodesc" placeholder="Add memo to self (your recipient won't see this)"></textarea>
                                        </div>
                                    </div>
                                    <div class="aui-item">
                                    </div>
                                </div>
                                <div id="aui-message-bar" class="mt20"></div>                                
                                <div class="aui-group aui-group-split">
                                    <div class="aui-item">
                                        <button class="aui-button aui-button-primary" id="send_invoice" style="font-size: 15px">Send</button>                                        
                                        <button class="aui-button" id="save_as_draft" style="font-size: 15px">Save as draft</button>
                                    </div>
                                    <div class="aui-item">
                                    </div>
                                </div>
                            </form>
                        </section>
                    </div>
                </div>
            </section>
            <footer id="footer" role="contentinfo">
                <section class="footer-body" style="background: url(images/logo.png) bottom no-repeat">
                </section>
            </footer>
        </div>
        <script id="connect-loader" data-options="sizeToParent:true;">
            (function () {
                var getUrlParam = function (param) {
                    var codedParam = (new RegExp(param + '=([^&]*)')).exec(window.location.search)[1];
                    return decodeURIComponent(codedParam);
                };

                var baseUrl = getUrlParam('xdm_e') + getUrlParam('cp');
                var options = document.getElementById('connect-loader').getAttribute('data-options');

                var script = document.createElement("script");
                script.src = baseUrl + '/atlassian-connect/all.js';

                if (options) {
                    script.setAttribute('data-options', options);
                }

                document.getElementsByTagName("head")[0].appendChild(script);
            })();
        </script>
        <script>
            AJS.$(document).ready(function () {                
                AJS.$('#issueDate').datePicker({
                    'overrideBrowserDefault': true,
                    'dateFormat': 'mm/dd/yy'
                });
                AJS.$('#dueDate').datePicker({
                    'overrideBrowserDefault': true,
                    'dateFormat': 'mm/dd/yy'
                });                

                AJS.$('#add_new_item').on('click', function (e) {
                    e.preventDefault();
                    var row_count = AJS.$('.ae_row').length;
                    var $parentTR = AJS.$('#ae_row_' + (row_count - 1));
                    var $html = '<tr class="ae_row" id="ae_row_' + row_count + '">';
                    $html += '<td headers="basic-desc">\n\
                          <input class="text full-width-field" type="text" id="itemName_' + row_count + '" name="itemName" title="Item name" placeholder="Item name">\n\
                          <textarea class="textarea full-width-field" name="itemDescription" id="itemDescription_' + row_count + '" placeholder="Enter detailed description (optional)" style="margin-top: 5px;"></textarea>\n\
                       </td>';
                    $html += '<td headers="basic-qty"><input class="text short-field" type="text" id="itemQty_' + row_count + '" name="itemQty" title="Quantity" value="1"></td>';
                    $html += '<td headers="basic-price"><input class="text short-field" type="text" id="itemPrice_' + row_count + '" name="itemPrice" title="Price" value="0.00"></td>';
                    $html += '<td headers="basic-tax"><input class="text short-field" type="text" id="taxName_' + row_count + '" name="taxName" title="Tax" placeholder="Name"> <input class="text short-field" type="text" id="taxRate_' + row_count + '" name="taxRate" title="Tax" placeholder="Amount" value="0.00"> %</td>';
                    $html += '<td headers="basic-amt" class="grey-bg"><input type="hidden" id="basicAmt_' + row_count + '" name="basicAmt"><input type="text" id="basicAmt_'+row_count+'" name="basicAmt" disabled="disabled" value="$0.00" class="text short-field"></td>';
                    $html += '<td style="cursor:pointer" class="remove_ae_row" data-rowNumber="' + row_count + '" id="remove_ae_row_' + row_count + '"><span class="aui-icon aui-icon-small aui-iconfont-cross-circle"></span></td>';
                    $html += '</tr>';

                    AJS.$($html).insertAfter($parentTR);
                });

                AJS.$(document).on('click', '.remove_ae_row', function (e) {
                    var row_number = AJS.$(this).attr('data-rownumber');
                    AJS.$('#ae_row_' + row_number).remove();

                    AJS.$('.ae_row').each(function (i) {
                        AJS.$(this).attr('id', 'ae_row_' + i);
                        AJS.$(this).find('input[name="itemName"]').attr('id', 'itemName_' + i);
                        AJS.$(this).find('.textarea').attr('id', 'itemDescription_' + i);
                        AJS.$(this).find('input[name="itemQty"]').attr('id', 'itemQty_' + i);
                        AJS.$(this).find('input[name="itemPrice"]').attr('id', 'itemPrice_' + i);
                        AJS.$(this).find('input[name="taxRate"]').attr('id', 'taxRate_' + i);
                        AJS.$(this).find('input[name="basicAmt"]').attr('id', 'basicAmt_' + i);
                        AJS.$(this).find('.remove_ae_row').attr('id', 'remove_ae_row_' + i);
                        AJS.$(this).find('.remove_ae_row').attr('data-rownumber', i);
                    });
                    countSubTotal();
	            countFinalTotal(AJS.$('input[name="invDiscount"]').val());
                });

                AJS.$("#allowPartialPayments").click(function () {
                    if (AJS.$(this).is(":checked")) {
                        AJS.$(".mamout").show(300);
                    } else {
                        AJS.$(".mamout").hide(200);
                    }
                });

                AJS.$("#addMemoDesc").click(function () {
                    if (AJS.$(this).is(":checked")) {
                        AJS.$(".aememodesc").show(300);
                    } else {
                        AJS.$(".aememodesc").hide(200);
                    }
                });

                 AJS.$(document).on('change blur keyup','input[id^="itemQty_"]', function () {
                    countSubTotal();
                });
                AJS.$(document).on('change blur keyup','input[id^="itemPrice_"]', function () {
                    countSubTotal();
                });
                AJS.$('input[name="invDiscount"]').on('change blur keyup', function () {
                    countFinalTotal(AJS.$(this).val());
                });
                AJS.$(document).on('change blur keyup','input[id^="taxRate_"]', function () {
                    countSubTotal();
                });

                AJS.$(document).on('change','select[name="invoiceDiscType"]', function () {
                    countFinalTotal(AJS.$('input[name="invDiscount"]').val());
                });

                AJS.$(document).on('change blur keyup','input[name="shippingAmount"]', function () {
                    countFinalTotal(AJS.$('input[name="invDiscount"]').val());
                });
                
                AJS.$(document).on('click','#send_invoice', function (e) {
                    e.preventDefault();
                    var invoiceNumber = AJS.$('#invoiceNumber').val();
                    var issueDate = AJS.$('#issueDate').val();
                    var reference = AJS.$('#reference').val();
                    var dueDate = AJS.$('#dueDate').val();
                    var billToEmail = AJS.$('#billToEmail').val();
                    var billToEmailCc = AJS.$('#billToEmailCc').val();
                    
                    var itemNames = AJS.$("input[name='itemName']").map(function(){return $(this).val();}).get();
                    var itemDescriptions = AJS.$("textarea[name='itemDescription']").map(function(){return $(this).val();}).get();
                    var itemQtys = AJS.$("input[name='itemQty']").map(function(){return $(this).val();}).get();
                    var itemPrices = AJS.$("input[name='itemPrice']").map(function(){return $(this).val();}).get();
                    
                    var taxNames = AJS.$("input[name='taxName']").map(function(){return $(this).val();}).get();
                    var taxRates = AJS.$("input[name='taxRate']").map(function(){return $(this).val();}).get();
                    var itemsAmts = AJS.$("input[name='basicAmt']").map(function(){return $(this).val();}).get();
                    
                    var partialPayments,allowTips = 'no';
                    var minimumDueAmount,memodesc = '';
                    if(AJS.$("#allowPartialPayments").is(":checked")){
                        partialPayments = 'yes';
                        minimumDueAmount = AJS.$("#minimumDueAmount").val();
                    }
                     if(AJS.$("#allowTips").is(":checked")){
                        allowTips = 'yes';
                    }
                    
                    var invDiscount = AJS.$("#invDiscount").val();
                    var invoiceDiscType = AJS.$("#invoiceDiscType").val();
                    var shippingAmount = AJS.$("#shippingAmount").val();
                    var itemSubTotal = AJS.$(".itemSubTotal").html();
                    var invoiceDiscountAmount = AJS.$(".invoiceDiscountAmount").html();
                    var shippingAmountTd = AJS.$(".shippingAmount").html();
                    var finalTotal = AJS.$(".finalTotal").html();
                    
                    var notes = AJS.$("#notes").val();
                    var terms = AJS.$("#terms").val();
                    
                    var addMemoDesc = 'no';
                    if(AJS.$("#addMemoDesc").is(":checked")){
                        addMemoDesc = 'yes';
                        memodesc = AJS.$("#memodesc").val();
                    }
                    var invoiceDiscObj ='';
                    if(invoiceDiscType === 'percentage'){
                        invoiceDiscObj = { type : 'Percent', 'Amount': invDiscount };
                    }
                    else{
                        invoiceDiscObj = { type : 'Amount', 'Amount' : invDiscount };
                    }
                    var mainItemObject = {};
                    var itemObj = Object();                     
                    AJS.$.each(itemNames, function( i, value ) {                         
                        itemObj = Object();
                        itemObj.Name = itemNames[i];
                        itemObj.Description = itemDescriptions[i];
                        itemObj.Quantity = itemQtys[i];
                        itemObj.UnitPrice = {'Currency':'USD','Value':itemPrices[i]};
                        itemObj.Tax ={'Name':taxNames[i],'Percent':taxRates[i]};
                        mainItemObject[i] = itemObj;                        
                      });                    
                      
                    var request =
                        {                            
                            Number : invoiceNumber,
                            //LogoUrl : AJS.$('#logoid').attr('src'),
                            LogoUrl : 'https://www.angelleye.com/wp-content/uploads/2015/06/angelleye-logo-159x43.png',
                            InvoiceDate : issueDate,
                            Reference : reference,
                            AllowPartialPayment : partialPayments,                                
                            Note : notes,
                            Terms : terms,
                            addMemoDesc : addMemoDesc,
                            MerchantMemo : memodesc,                            
                            MinimumAmountDue :minimumDueAmount,                            
                            DueDate : dueDate,                            
                            BillingEmail : billToEmail,                            
                            ccEmail : billToEmailCc,                           
                            itemArray : mainItemObject,
                            finalDiscountForInvoice : invoiceDiscObj,
                            ShippingCost : shippingAmount
                        };                                       
                    $.ajax({ 
                        type: 'POST',
                        url: 'CreateAndSendInvoice.php',
                        beforeSend: function () {
                            AJS.$('#send_invoice').text('Processing...');
                        },
                        complete: function () {
                            
                        },
                        data: {
                            create_invoice_request : JSON.stringify(request)
                        },
                        dataType: "json",                        
                        success: function (result) {
                            if(result.success == 'true'){
                                AJS.$('#send_invoice').text('Complete');
                                AJS.messages.success({
                                    title: 'Success',
                                    body: '<p> '+result.msg+' </p>'
                                });                                
                            }
                            else if(result.success == 'successwithwarning'){
                                AJS.$('#send_invoice').text('Complete');
                                AJS.messages.info({
                                    title: 'Success',
                                    body: '<p> '+result.msg+' </p>'
                                });
                            }
                            else if(result.success == 'false'){
                                var name,field_details = '';      
                                AJS.$('#send_invoice').text('Try Again');
                                if('errors' in result.error){                                    
                                    if ('name' in result.error.errors){
                                        name = result.error.errors.name;
                                    }
                                    if ('details' in result.error.errors){
                                        var details = result.error.errors.details;
                                        AJS.$.each(details,function(index, item){
                                            field_details += '<p><strong>'+item.field+' </strong>'+item.issue+'</p>';                                            
                                        });
                                    }
                                }
                                AJS.messages.error({
                                    title: 'PayPal Error',
                                    body: '<p> '+result.msg+'</p><p>'+name+'</p>'+field_details
                                });                                
                            }
                        }
                    });
                                        
                });
                      
                
                AJS.$(document).on('click','#save_as_draft', function (e) {
                    e.preventDefault();
                });
                
            });

            function countFinalTotal(val) {
                var total = Number(AJS.$('.itemSubTotal').text().replace(/[^0-9\.-]+/g, ""));
                var discountBase = AJS.$('select[name="invoiceDiscType"]').val();
                var discount = parseFloat(val);
                var discountAmt = 0;
                if (discountBase == 'percentage') {
                    discountAmt = parseFloat((total * discount) / 100);
                } else if (discountBase == 'dollar') {
                    discountAmt = parseFloat(val);
                }                
                AJS.$('.invoiceDiscountAmount').text('$' + discountAmt.toFixed(2));
                
                var shippingAmount = parseFloat(AJS.$('input[name="shippingAmount"]').val());
                if (shippingAmount == '')
                    shippingAmount = 0;
                AJS.$('.shippingAmountTd').text('$' + shippingAmount.toFixed(2));

                var finalTotal = total - discountAmt + shippingAmount;

                AJS.$('.finalTotal').text('$'+finalTotal.toFixed(2) + ' USD');
            }

            function countSubTotal() {
                var total = 0;
                AJS.$('input[id^="itemQty_"]').each(function () {
                    var qty = parseInt(AJS.$(this).val());
                    var price = parseFloat(AJS.$(this).parent().next().find('input[id^="itemPrice_"]').val());
                    var tax=parseFloat(AJS.$(this).parent().next().next().find('input[id^="taxRate_"]').val());
                    var amount = (qty * price);
                    var temp_amount = ((amount*tax)/100);
                    amount = amount + temp_amount;                    
                    AJS.$(this).parent().siblings('.grey-bg').find('input[name="basicAmt"]').val('$'+amount.toFixed(2));
                    total = total + amount;
                });
                AJS.$('.itemSubTotal').text('$' + total.toFixed(2));
                countFinalTotal(AJS.$('input[name="invDiscount"]').val());
            }
        </script>

    </body>

</html>
